{% extends "base.html" %}

{% block title %}Get Weekly Game Updates!{% endblock %}

{% block meta %}
<meta
  name="description"
  content="Subscribe to our newsletter to receive the latest game updates from Prime Gaming, Epic Store, and more!"
/>
<meta
  name="keywords"
  content="Newsletter, Gaming Updates, Free Games, Email Subscription, Prime Gaming, Epic Store"
/>
{% endblock meta %}

{% block content %}
<!-- About Section -->
<section class="container my-5" id="about">
  <div class="row align-items-center">
    <div class="col-lg-6 mb-4 mb-lg-0">
      <h3>About WeeklyGameVault</h3>
      <p>
        WeeklyGameVault is dedicated to bringing you the latest and greatest free games from top gaming platforms.
        Whether you're a casual gamer or a hardcore enthusiast, our newsletter ensures you never miss out on
        exciting opportunities to expand your game library without spending a dime.
      </p>
      <ul class="list-unstyled">
        <li class="mb-2">
          <i class="fas fa-check-circle text-success me-2"></i>Weekly Updates
        </li>
        <li class="mb-2">
          <i class="fas fa-check-circle text-success me-2"></i>Everything in one Newsletter
        </li>
        <li class="mb-2">
          <i class="fas fa-check-circle text-success me-2"></i>User-Friendly Interface
        </li>
      </ul>
    </div>
    <div class="col-lg-6">
      <img
        src="{{ url_for('static', filename='images/vault.png') }}"
        alt="Vault filled with games in pixel art"
        class="img-fluid rounded shadow"
      >
    </div>
  </div>
</section>

<!-- Subscribe Section -->
<div class="container my-5" id="subscribe">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
      <div class="subscribe-card card">
        <div class="card-body">
          <h2 class="card-title mb-4 text-center">Stay Updated with our Newsletter</h2>
          <p class="card-text text-center">
            Donâ€™t miss out on the latest free games! Subscribe to receive timely updates directly to your inbox.
          </p>

          <form id="newsletterForm">
            <div class="mb-4">
              <label for="emailInput" class="form-label visually-hidden">Email address</label>
              <input
                type="email"
                class="form-control"
                id="emailInput"
                name="email"
                placeholder="Enter your email address"
                required
              />
            </div>

            <!-- Frequency Selection (Required) -->
            <div class="mb-4">
              <p class="mb-2" style="font-weight: 500;">How often do you want to receive our newsletter?</p>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="frequency"
                  id="weeklyOption"
                  value="weekly"
                  required
                >
                <label class="form-check-label" for="weeklyOption">Weekly</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="frequency"
                  id="newGameOption"
                  value="newgame"
                  required
                >
                <label class="form-check-label" for="newGameOption">Every time a new game is available</label>
              </div>
              <div class="form-check form-check-inline">
                <input
                  class="form-check-input"
                  type="radio"
                  name="frequency"
                  id="bothOption"
                  value="both"
                  required
                >
                <label class="form-check-label" for="bothOption">Both</label>
              </div>
            </div>

            <button type="submit" class="btn btn-primary w-100" id="subscribeBtn">
              <span
                class="spinner-border spinner-border-sm me-2"
                role="status"
                aria-hidden="true"
                id="loadingSpinner"
                style="display: none;"
              ></span>
              Subscribe
            </button>
            <div class="mt-4 text-center">
              <small class="text-muted">We respect your privacy. Unsubscribe at any time.</small>
            </div>
            <p class="message mt-3 text-center" id="statusMessage"></p>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extra_scripts %}
<script>
  // Newsletter Form Submission
  document
    .getElementById("newsletterForm")
    .addEventListener("submit", async function (event) {
      event.preventDefault();

      const emailInput = document.getElementById("emailInput");
      const statusMessage = document.getElementById("statusMessage");
      const subscribeBtn = document.getElementById("subscribeBtn");
      const loadingSpinner = document.getElementById("loadingSpinner");

      // Show spinner and disable button to prevent multiple clicks
      loadingSpinner.style.display = "inline-block";
      subscribeBtn.disabled = true;

      // Collect form data
      const formData = new FormData();
      formData.append("email", emailInput.value);

      // Append frequency (one of the radio buttons)
      const frequencyElems = document.getElementsByName("frequency");
      let selectedFrequency = "";
      for (let i = 0; i < frequencyElems.length; i++) {
        if (frequencyElems[i].checked) {
          selectedFrequency = frequencyElems[i].value;
          break;
        }
      }
      formData.append("frequency", selectedFrequency);

      try {
        const response = await fetch("/subscribe", {
          method: "POST",
          body: formData,
        });

        // Once we get a response, hide the spinner and enable the button again
        loadingSpinner.style.display = "none";
        subscribeBtn.disabled = false;

        if (response.ok) {
          const message = await response.text();
          statusMessage.textContent = message;
          statusMessage.style.color = "#28a745"; // Green
          emailInput.value = "";
          // Uncheck the radio buttons
          frequencyElems.forEach(radio => (radio.checked = false));
        } else if (response.status === 429) {
          // Rate limit exceeded
          statusMessage.textContent =
            "You have made too many requests. Please try again later.";
          statusMessage.style.color = "#dc3545"; // Red
        } else {
          const errorMessage = await response.text();
          statusMessage.textContent = `Error: ${errorMessage}`;
          statusMessage.style.color = "#dc3545"; // Red
        }
      } catch (error) {
        // Hide spinner, enable button
        loadingSpinner.style.display = "none";
        subscribeBtn.disabled = false;

        statusMessage.textContent = "An unexpected error occurred.";
        statusMessage.style.color = "#dc3545"; // Red
      }
    });
</script>
{% endblock extra_scripts %}
